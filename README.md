# Step-By-Step Guide for training the model
## Data Pre-Processing
- Required Files
1.	mzML/mzXML file containing top-down spectral data. Alternatively, a Raw file can also be used
2.	A corresponding protein database file in fasta format
- Process
1.	Use ProteoWizard MSConvert for converting raw file into mzML file. 
a.	Make sure you have selected the peak picking option for obtaining the centroided data. 
b.	The process is described as File format conversion @ http://proteomics.informatics.iupui.edu/software/toppic/tutorial.html 
2.	Use TopFD to deconvolute mzML/mzXML file (branch: for_EnvCNN)
a.	The process will generate feature files, msalign files and a list of env files. 
3.	Use TopPIC to perform proteoforms search. It will utilize, protein DB (fasta) file, msalign files and feature files. Make sure you save temporary files.  
```./toppic -k -p 0 -d -t FDR -v 1E-10 -T FDR -V 1E-10 protein_db.fasta spectrum.msalign```

## Data Processing for Training
- Required Files
1.	env files generated by TopFD
2.	prsms xml files reported by TopPIC
- Process 
1.	Rename the prsm xml files obtained using TopPIC. The files are renamed to “sp_spectrumID.xml”
```EnvelopeCNN/src/EnvCNN/linux_batch_scripts/rename_xml_files.sh```
2.	Rename the env files obtained using TopFD. The files are renamed to “sp_spectrumID.env”
```EnvelopeCNN/src/EnvCNN/linux_batch_scripts/rename_env_files.sh```
3.	Suggestion: Make a new directory (Data) and copy the renamed files (both xml and env files) into that folder. Move to that folder and do the onward analysis.
4.	Generate the annotated spectra files using the “sp_spectrumID.env” and “sp_spectrumID.xml” files
```EnvelopCNN/src/EnvCNN/linux_batch_scripts/add_anno.sh```
5.	Using the annotated files, generate the feature file. 
```EnvelopCNN/src/EnvCNN/linux_batch_scripts/add_feature.sh```
6.	Using the feature file, generate the training data. The training data comprise of csv files wherein each csv file contains a matrix corresponding to an env and matrix has a size of 300x7. 
```EnvelopeCNN/src/EnvCNN/linux_batch_scripts/generate_training_data.sh```
7.	Now, using the Training data, create an HDF5 file. The HDF5 file contains three partitions: Train, Validation, and Test.
```/EnvelopeCNN/src/EnvCNN/Exec/create_hdf5_file.py TrainData/```

## Train Model
1.	Train the model using the HDF5 file. It will generate training plots (loss and accuracy) and will save the trained model in the form of h5 file. Here you have multiple options to train the model. <br/>
i.	You can train model using CPU and GPUs <br/>
```/EnvelopeCNN/src/EnvCNN/Exec/train_model_hdf5.py dataset.hdf5```<br/>
ii.	You can train model using multi-GPUs <br/>

## Test Model
1.	Using the saved model, test the model performance. Reports test accuracy and loss, ROC curve, label distribution, and b/y ions label distribution and accuracies<br/>
```/EnvelopeCNN/src/EnvCNN/Exec/test_model.py dataset.hdf5 output/```<br/>
2.	Add prediction score in the env files and generate a new list of envelopes with the predicted and TopFD score. Data directory contains feature files. <br/>
```/EnvelopeCNN/src/EnvCNN/Exec/add_prediction_score.py Data/ output/```<br/>
3.	Generate the Rank Plot using the newly generated envelope files. It will also save the values in Console.txt<br/>
```/EnvelopeCNN/src/EnvCNN/Exec/draw_rank_plot.py ./output/output_envs/ > Console.txt```<br/>

## Evaluate the model performance
1.	Using the model_convert.py provided in Frugally-deep library convert your model to json file
2.	Using the json file, run the modified TopFD version. This will report the new msalign files, feature files and env files.
3.	Use the newly generated files and protein database, perform the proteoforms identification on TopPIC. 
4.	Using the newly generated prsms and envs, generate the annotated files as described earlier
5.	Generate the Rank plot using the newly generated annotated files. 
