# Step-By-Step Guide for training the model
## Data Pre-Processing ##
#### Required Files ####
1.	An mzML/mzXML file containing top-down spectral data. Alternatively, a Raw file can also be used.
2.	A corresponding protein database file in fasta format.  
#### Process ####
1.	Use ProteoWizard MSConvert to convert raw file into mzML file. 
    1.	Make sure you have selected the peak picking option for obtaining the centroided data. 
    2.	The process is described in *"File format conversion"* at http://proteomics.informatics.iupui.edu/software/toppic/tutorial.html 
2.	Use TopFD to deconvolute mzML/mzXML file.  
```./topfd spectrum.mzml```
    1.	You can download/clone the code from https://github.com/toppic-suite/toppic-suite/tree/master using GitHub branch *"for_EnvCNN"*.
    2.  The process will generate feature files, msalign files and a list of env files.
3.	Use TopPIC to perform proteoforms search.  
```./toppic -k -p 0 -d -t FDR -v 1E-10 -T FDR -V 1E-10 protein_db.fasta spectrum.msalign```
    1.  It will utilize protein database (*.fasta) file, msalign files and feature files.
    2.  Make sure you save temporary files.  

## Generating Training Data ##
#### Required Files ####
1.	Envelope files (*.env) files generated by TopFD.
2.	PrSM files (*.xml) files reported by TopPIC.  
#### Process ####
1.	Rename the PrSM (*.xml) files obtained using TopPIC. The files are renamed to “sp_spectrumID.xml”.  
```envcnn/src/EnvCNN/linux_batch_scripts/rename_xml_files.sh```
2.	Rename the Envelope (*.env) files obtained using TopFD. The files are renamed to “sp_spectrumID.env”.  
```envcnn/src/EnvCNN/linux_batch_scripts/rename_env_files.sh```
    1.  Make a new directory called *data*.
    2.  Copy the renamed files (both “sp_spectrumID.xml” and “sp_spectrumID.env” data files) into the *data* directory. 
    2.  Switch to the *data* directory for the onward analysis.
3.	Generate the annotated spectra files.  
```envcnn/src/EnvCNN/linux_batch_scripts/add_anno.sh```
    1.  The script will read the “sp_spectrumID.env” and “sp_spectrumID.xml” files from the *data* directory.
    2.  It will generate the "annotated_spectrumID.env" files.
4.	Generate the feature file.  
```envcnn/src/EnvCNN/linux_batch_scripts/add_feature.sh```
    1.  The script will read the “annotated_spectrumID.env” files from the *data* directory.
    2.  It will generate the "feature_spectrumID.env" files.
5.	Generate the training data.   
```envcnn/src/EnvCNN/linux_batch_scripts/generate_training_data.sh```
    1.  The script will read the “feature_spectrumID.env” files from the *data* directory.
    2.  The script will generate a folder named *TrainData*.
    3.  *TrainData* folder will contain training data matrix files for each envelope, "matrix_spectrumID_envelopeID.csv", a label file and a parameter file.
6.	HDF5 file generation  
```/envcnn/src/EnvCNN/Exec/create_hdf5_file.py TrainData/```
    1.  Move outside *data* directory.
    2.  Using the Training data in *TrainData* directory, create an HDF5 file.
    3.  The HDF5 file contains three partitions for training, validation, and test data.

## Train Model
1.	Train the model using the HDF5 file. It will generate training plots (loss and accuracy) and will save the trained model in the form of h5 file. Here you have multiple options to train the model. <br/>
i.	You can train model using CPU and GPUs <br/>
```/EnvelopeCNN/src/EnvCNN/Exec/train_model_hdf5.py dataset.hdf5```<br/>
ii.	You can train model using multi-GPUs <br/>

## Test Model
1.	Using the saved model, test the model performance. Reports test accuracy and loss, ROC curve, label distribution, and b/y ions label distribution and accuracies<br/>
```/EnvelopeCNN/src/EnvCNN/Exec/test_model.py dataset.hdf5 output/```<br/>
2.	Add prediction score in the env files and generate a new list of envelopes with the predicted and TopFD score. Data directory contains feature files. <br/>
```/EnvelopeCNN/src/EnvCNN/Exec/add_prediction_score.py Data/ output/```<br/>
3.	Generate the Rank Plot using the newly generated envelope files. It will also save the values in Console.txt<br/>
```/EnvelopeCNN/src/EnvCNN/Exec/draw_rank_plot.py ./output/output_envs/ > Console.txt```<br/>

## Evaluate the model performance
1.	Using the model_convert.py provided in Frugally-deep library convert your model to json file
2.	Using the json file, run the modified TopFD version. This will report the new msalign files, feature files and env files.
3.	Use the newly generated files and protein database, perform the proteoforms identification on TopPIC. 
4.	Using the newly generated prsms and envs, generate the annotated files as described earlier
5.	Generate the Rank plot using the newly generated annotated files. 
